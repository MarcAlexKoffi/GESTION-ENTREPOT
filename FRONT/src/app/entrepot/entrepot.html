<div class="pageMain">
  <div class="page-root">
    <div class="page-center">
      <div class="page-shell">
        <!-- HEADER -->
        <header class="page-header">
          <div class="page-title-block">
            <p class="page-title">{{ entrepot.nom }}</p>
            <p class="page-subtitle">{{ entrepot.lieu }}</p>
          </div>
          <button type="button" class="btn-back" [routerLink]="'/dashboard/dashboard-main'">
            <span class="material-symbols-outlined">arrow_back</span>
            <span class="truncate">Retour aux entrepôts</span>
          </button>
        </header>

        <!-- STATS -->
        <section class="stats-grid" aria-label="Statistiques de l'entrepôt">
          <article class="stat-card">
            <p class="stat-label">Total camions</p>
            <p class="stat-value">{{ totalCamionsArrives }}</p>
          </article>

          <article class="stat-card">
            <p class="stat-label">En attente de validation</p>
            <p class="stat-value">{{ nbPending }}</p>
          </article>

          <article class="stat-card">
            <p class="stat-label">Validés</p>
            <p class="stat-value">{{ nbValidated }}</p>
          </article>
          <article class="stat-card">
            <p class="stat-label">Réintégrés</p>
            <p class="stat-value">{{ nbReintegres }}</p>
          </article>
          <article class="stat-card">
            <p class="stat-label">Acceptés</p>
            <p class="stat-value">{{ nbAccepted }}</p>
          </article>

          <article class="stat-card">
            <p class="stat-label">Refoulés</p>
            <p class="stat-value">{{ nbCancelled }}</p>
          </article>

          <article class="stat-card">
            <p class="stat-label">Renvoyés</p>
            <p class="stat-value">{{ nbRenvoyes }}</p>
          </article>
        </section>

        <!-- TOOLBAR -->
        <section class="toolbar">
          <div class="toolbar-left">
            <div class="search-wrapper">
              <div class="search-icon">
                <span class="material-symbols-outlined">search</span>
              </div>
              <input
                type="text"
                class="search-input"
                placeholder="Rechercher..."
                [(ngModel)]="searchTerm"
              />
            </div>

            <div class="period-chip" (click)="togglePeriodDropdown()">
              <span class="material-symbols-outlined">calendar_today</span>

              <span class="period-value">{{ selectedPeriodLabel }}</span>

              <span class="material-symbols-outlined period-caret">expand_more</span>

              <div
                class="period-menu"
                *ngIf="showPeriodDropdown"
                (click)="$event.stopPropagation()"
              >
                <button type="button" class="period-item" (click)="setPeriod('today')">
                  Aujourd'hui
                </button>
                <button type="button" class="period-item" (click)="setPeriod('7days')">
                  7 derniers jours
                </button>
                <button type="button" class="period-item" (click)="setPeriod('30days')">
                  30 derniers jours
                </button>
                <button type="button" class="period-item" (click)="setPeriod('all')">
                  Toutes périodes
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- MAIN CARD -->
        <section class="card">
          <!-- TABS -->
          <div class="tabs-header">
            <div class="tabs-row">
              <!-- EN ATTENTE DE VALIDATION -->
              <a
                href="#"
                class="tab-link"
                [class.tab-link--active]="currentTab === 'pending'"
                (click)="setTab('pending'); $event.preventDefault()"
              >
                <span>En attente de validation</span>
                <span class="tab-pill">{{ nbPending }}</span>
              </a>

              <!-- VALIDÉS -->
              <a
                href="#"
                class="tab-link"
                [class.tab-link--active]="currentTab === 'validated'"
                (click)="setTab('validated'); $event.preventDefault()"
              >
                <span>Validés</span>
                <span class="tab-pill">{{ nbValidated }}</span>
              </a>
              <!-- ACCEPTES -->
              <a
                href="#"
                class="tab-link"
                [class.tab-link--active]="currentTab === 'accepted'"
                (click)="setTab('accepted'); $event.preventDefault()"
              >
                <span>Acceptés</span>
                <span class="tab-pill">{{ nbAccepted }}</span>
              </a>

              <!-- REFOULÉS -->
              <a
                href="#"
                class="tab-link"
                [class.tab-link--active]="currentTab === 'cancelled'"
                (click)="setTab('cancelled'); $event.preventDefault()"
              >
                <span>Refoulés</span>
                <span class="tab-pill">{{ nbCancelled }}</span>
              </a>

              <!-- RENVOYÉS (NOUVEAU) -->
              <a
                href="#"
                class="tab-link"
                [class.tab-link--active]="currentTab === 'renvoyes'"
                (click)="setTab('renvoyes'); $event.preventDefault()"
              >
                <span>Renvoyés</span>
                <span class="tab-pill">{{ nbRenvoyes }}</span>
              </a>
            </div>
          </div>

          <!-- TABLEAU CAMIONS -->
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Immatriculation</th>
                  <th>Transporteur</th>
                  <th>Heure</th>
                  <th>Statut</th>
                  <th>Statut avancé</th>
                  <th class="cell-actions">Actions</th>
                </tr>
              </thead>

              <tbody>
                <!-- AUCUN -->
                <tr *ngIf="filteredTrucks.length === 0">
                  <td colspan="6" class="cell-muted">
                    Aucun camion pour ce statut pour le moment.
                  </td>
                </tr>
                <!-- LIGNES -->
                <tr *ngFor="let t of filteredTrucks">
                  <td class="cell-main">
                    {{ t.immatriculation }}
                    <span *ngIf="t.unreadForAdmin" class="badge-new">Nouveau</span>
                  </td>
                  <td class="cell-muted">{{ t.transporteur }}</td>
                  <td class="cell-muted">{{ getHourForCurrentTab(t) }}</td>
                  <td class="cell-status">
                    <span [ngClass]="getStatusClass(t)">
                      <span class="material-symbols-outlined status-icon" aria-hidden="true">{{
                        getStatusIcon(t)
                      }}</span>
                      <span class="status-text">{{ getStatusLabel(t) }}</span>
                    </span>
                  </td>

                  <td class="cell-muted">
                    <span [ngClass]="getAdvancedStatusClass(t)">
                      <span class="material-symbols-outlined status-icon">{{
                        getAdvancedStatusIcon(t)
                      }}</span>
                      <span class="adv-label">{{ getAdvancedStatusLabel(t) }}</span>
                    </span>
                  </td>
                  <td class="cell-actions">
                    <button type="button" class="link-action" (click)="openDetailsModal(t)">
                      Voir plus
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="showDetailsModal">
    <div class="truck-modal">
      <!-- HEADER -->
      <div class="truck-modal-header">
        <h2>Détails du camion</h2>
        <button class="truck-modal-close" (click)="closeDetailsModal()" aria-label="Fermer">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- BODY -->
      <div class="truck-modal-body" *ngIf="selectedTruck">
        <div class="field">
          <label>Immatriculation</label>
          <input class="truck-input" [value]="selectedTruck.immatriculation" disabled />
        </div>

        <div class="field">
          <label>Transporteur</label>
          <input class="truck-input" [value]="selectedTruck.transporteur" disabled />
        </div>

        <div class="field">
          <label>Coopérative</label>
          <input class="truck-input" [value]="selectedTruck.cooperative || '—'" disabled />
        </div>

        <div class="field">
          <label>Fiche de transfert</label>
          <input class="truck-input" [value]="selectedTruck.transfert" disabled />
        </div>

        <div class="field">
          <label>KOR</label>
          <input class="truck-input" [value]="selectedTruck.kor" disabled />
        </div>

        <div class="field">
          <label>TH</label>
          <input class="truck-input" [value]="selectedTruck.th || '—'" disabled />
        </div>

        <!-- PRODUCT / OPERATOR-ENTERED DETAILS -->
        <div *ngIf="selectedTruck && selectedTruck.products">
          <div class="field">
            <label>Numéro de lot</label>
            <input class="truck-input" [value]="selectedTruck.products.numeroLot || '—'" disabled />
          </div>

          <div class="field">
            <label>Nombre de sacs</label>
            <input
              class="truck-input"
              [value]="selectedTruck.products.nombreSacsDecharges || '—'"
              disabled
            />
          </div>

          <div class="field">
            <label>Poids brut</label>
            <input class="truck-input" [value]="selectedTruck.products.poidsBrut || '—'" disabled />
          </div>

          <div class="field">
            <label>Poids net</label>
            <input class="truck-input" [value]="selectedTruck.products.poidsNet || '—'" disabled />
          </div>
        </div>

        <div class="field">
          <label>Heure d’arrivée</label>
          <input
            class="truck-input"
            [value]="selectedTruck.heureArrivee | date : 'HH:mm'"
            disabled
          />
        </div>

        <!-- COMMENTAIRE ADMIN -->
        <div class="field">
          <label>Commentaire administrateur</label>
          <textarea
            class="truck-textarea"
            [(ngModel)]="adminComment"
            placeholder="Ajouter un commentaire (visible par le gérant)"
          ></textarea>
        </div>
      </div>

      <!-- FOOTER (ACTIONS CONTEXTUELLES) -->
      <div class="truck-modal-footer">
        <!-- EN ATTENTE -->
        <ng-container *ngIf="selectedTruck?.statut === 'En attente'">
          <button class="truck-submit success" (click)="validateTruck()">Valider</button>
          <button class="truck-submit danger" (click)="refuseTruck()">Refouler</button>
        </ng-container>

        <!-- VALIDÉ -->
        <!-- <ng-container *ngIf="isValidatedOnly(selectedTruck!)">
          <button class="truck-submit" (click)="openHistoryModal(selectedTruck!)">
            Voir historique
          </button>
        </ng-container> -->

        <!-- ACCEPTÉ -->
        <ng-container *ngIf="isAcceptedFinal(selectedTruck!)">
          <!-- <button class="truck-submit" (click)="openHistoryModal(selectedTruck!)">
            Voir historique
          </button> -->
          <button class="truck-submit" (click)="printSelectedTruck()">Imprimer</button>
        </ng-container>

        <!-- REFOULÉ -->
        <ng-container *ngIf="isRefused(selectedTruck!)">
          <button class="truck-submit" (click)="openHistoryModal(selectedTruck!)">
            Voir historique
          </button>
          <button class="truck-submit success" (click)="reintegrateTruck()">
            <span class="material-symbols-outlined">restore</span>
            &nbsp;Réintégrer
          </button>
        </ng-container>
      </div>
    </div>
  </div>
  <!-- ============================
     MODALE HISTORIQUE CAMION
     ============================ -->
  <div class="modal" *ngIf="showHistoryModal">
    <div class="truck-modal">
      <div class="truck-modal-header">
        <h2>Historique du camion</h2>
        <button class="truck-modal-close" (click)="closeHistoryModal()" aria-label="Fermer">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="truck-modal-body" *ngIf="historyTruck">
        <div *ngIf="!historyTruck.history || historyTruck.history.length === 0" class="notif-empty">
          Aucun historique disponible.
        </div>

        <div *ngFor="let h of historyTruck.history" class="history-item">
          <div class="history-event">{{ h.event }}</div>
          <div class="history-meta">{{ h.by }} — {{ h.date | date : 'short' }}</div>
        </div>
      </div>

      <div class="truck-modal-footer">
        <button class="truck-submit" (click)="closeHistoryModal()">Fermer</button>
      </div>
    </div>
  </div>
</div>
