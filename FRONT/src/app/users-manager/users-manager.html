<div class="pageMain">
  <div class="admin-root">
    <main class="admin-main">
      <div class="admin-scroll">
        <div class="content">
          <div class="page-head">
            <div>
              <h2 class="page-title">Utilisateurs</h2>
              <p class="page-desc">Gérez les accès et affectez les entrepôts aux opérateurs.</p>
            </div>

            <button class="btn-primary" type="button" (click)="openCreateUser()">
              <span class="material-symbols-outlined" style="font-size: 20px">add</span>
              <span>Créer un utilisateur</span>
            </button>
          </div>

          <!-- mini toast -->
          <div *ngIf="toastMessage" style="margin: 10px 0">
            <div class="card" style="padding: 12px 14px">
              {{ toastMessage }}
            </div>
          </div>

          <section class="card filters" aria-label="Filtres">
            <div class="filters-row">
              <div class="field">
                <span class="left-icon">
                  <span class="material-symbols-outlined" style="font-size: 20px">search</span>
                </span>
                <input
                  class="with-left-icon"
                  type="text"
                  placeholder="Rechercher par nom ou identifiant..."
                  [(ngModel)]="searchTerm"
                />
              </div>

              <div class="select-wrap">
                <select aria-label="Filtrer par rôle" [(ngModel)]="selectedRole">
                  <option value="">Tous les rôles</option>
                  <option value="admin">Administrateur</option>
                  <option value="operator">Opérateur</option>
                </select>
              </div>

              <div class="select-wrap">
                <select aria-label="Filtrer par entrepôt" [(ngModel)]="selectedWarehouseId">
                  <option value="">Tous les entrepôts</option>
                  <option *ngFor="let w of warehouses" [value]="w.id">{{ w.name }}</option>
                </select>
              </div>
            </div>
          </section>

          <section class="card" aria-label="Liste des utilisateurs">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Rôle</th>
                    <th class="hide-md" style="width: 320px">
                      <span style="display: inline-flex; align-items: center; gap: 6px">
                        Entrepôt
                        <span
                          class="material-symbols-outlined"
                          style="font-size: 16px; color: var(--text-sub)"
                          >info</span
                        >
                      </span>
                    </th>
                    <th>Statut</th>
                    <th style="text-align: right">Actions</th>
                  </tr>
                </thead>

                <tbody>
                  <tr *ngIf="filteredUsers.length === 0">
                    <td colspan="6" class="sub">Aucun utilisateur ne correspond aux filtres.</td>
                  </tr>

                  <tr *ngFor="let u of filteredUsers">
                    <td>
                      <div class="user-cell">
                        <div class="initials">{{ getInitials(u.nom) }}</div>
                        <div style="display: flex; flex-direction: column">
                          <span class="name">{{ u.nom }}</span>
                          <span class="sub" style="font-size: 0.8em; color: var(--text-sub)">{{
                            u.username
                          }}</span>
                        </div>
                      </div>
                    </td>

                    <td>
                      <span class="badge">
                        <span class="material-symbols-outlined">{{ roleIcon(u.role) }}</span>
                        {{ roleLabel(u.role) }}
                      </span>
                    </td>

                    <td class="hide-md">
                      <!-- Select intelligent: désactivé pour admin, et MAJ directe -->
                      <select
                        class="warehouse-select"
                        [disabled]="warehouses.length === 0 || u.role === 'admin'"
                        [ngModel]="u.entrepotId ?? ''"
                        (ngModelChange)="updateUserWarehouse(u, $event)"
                      >
                        <option value="">—</option>
                        <option *ngFor="let w of warehouses" [value]="w.id">{{ w.name }}</option>
                      </select>
                    </td>

                    <td>
                      <span class="status" [ngClass]="statusClass(u.status)">
                        <span class="dot"></span>
                        {{ u.status }}
                      </span>
                    </td>

                    <td>
                      <div class="row-actions">
                        <button
                          class="mini-btn"
                          title="Modifier"
                          type="button"
                          (click)="openEditUser(u)"
                        >
                          <span class="material-symbols-outlined" style="font-size: 20px"
                            >edit</span
                          >
                        </button>

                        <button
                          class="mini-btn danger"
                          title="Supprimer"
                          type="button"
                          (click)="deleteUser(u)"
                        >
                          <span class="material-symbols-outlined" style="font-size: 20px"
                            >delete</span
                          >
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- MODAL create/edit user -->
          <div class="modal" *ngIf="showUserModal">
            <div class="modal__backdrop" (click)="closeUserModal()"></div>

            <div class="modal__panel" style="max-width: 720px; width: calc(100% - 24px)">
              <div class="truck-modal-header">
                <h2 class="truck-modal-title">
                  {{ isEditMode ? 'Modifier l’utilisateur' : 'Créer un utilisateur' }}
                </h2>
                <button
                  type="button"
                  class="truck-modal-close"
                  aria-label="Fermer"
                  (click)="closeUserModal()"
                >
                  <span class="material-symbols-outlined">close</span>
                </button>
              </div>

              <div class="truck-modal-body">
                <div class="truck-field">
                  <label class="truck-label">Nom complet</label>
                  <input
                    class="truck-input"
                    type="text"
                    placeholder="Ex : Jean Dupont"
                    [(ngModel)]="formUser.nom"
                  />
                </div>

                <div class="truck-field">
                  <label class="truck-label">Identifiant</label>
                  <input
                    class="truck-input"
                    type="text"
                    placeholder="Ex : jdupont"
                    [(ngModel)]="formUser.username"
                  />
                </div>

                <!-- PASSWORD: optionnel en édition -->
                <div class="truck-field">
                  <label class="truck-label"
                    >Mot de passe
                    {{ isEditMode ? '(laisser vide pour ne pas changer)' : '' }}</label
                  >
                  <input
                    class="truck-input"
                    type="password"
                    placeholder="••••••••"
                    [(ngModel)]="formUser.password"
                  />
                </div>

                <div class="truck-field">
                  <label class="truck-label">Rôle</label>
                  <select class="truck-select" [(ngModel)]="formUser.role">
                    <option value="admin">Administrateur</option>
                    <option value="operator">Opérateur</option>
                  </select>
                </div>

                <!-- Entrepôt: requis pour Opérateur, caché/désactivé pour Admin -->
                <div class="truck-field" *ngIf="formUser.role === 'operator'">
                  <label class="truck-label">Entrepôt</label>
                  <select
                    class="truck-select"
                    [(ngModel)]="formUser.entrepotId"
                    [disabled]="warehouses.length === 0"
                  >
                    <option *ngFor="let w of warehouses" [ngValue]="w.id">{{ w.name }}</option>
                  </select>
                  <p class="truck-help" *ngIf="warehouses.length === 0" style="color: red">
                    Aucun entrepôt disponible.
                  </p>
                </div>

                <div class="truck-field">
                  <label class="truck-label">Statut</label>
                  <select class="truck-select" [(ngModel)]="formUser.status">
                    <option value="Actif">Actif</option>
                    <option value="Inactif">Inactif</option>
                    <option value="En attente">En attente</option>
                  </select>
                </div>
              </div>

              <div class="truck-modal-footer" style="justify-content: flex-end">
                <button type="button" class="truck-submit" (click)="saveUserFromModal()">
                  {{ isEditMode ? 'Enregistrer' : 'Créer' }}
                </button>
              </div>
            </div>
          </div>
          <!-- END MODAL -->
        </div>
      </div>
    </main>
  </div>
</div>
