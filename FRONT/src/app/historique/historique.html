<body>
  <div class="page-root">
    <main class="page-main">
      <div class="page-container">
        <!-- HEADER -->
        <header class="page-header">
          <div class="page-title-block">
            <p class="page-title">Historique des passages</p>
            <p class="page-subtitle">
              Consultez et filtrez l'historique de tous les passages de camions.
            </p>
          </div>
          <button
            type="button"
            class="primary-chip-button"
            (click)="exporterCSV()"
            [disabled]="filteredRows.length === 0"
          >
            <span class="material-symbols-outlined">download</span>
            <span>Exporter</span>
          </button>
        </header>
        <!-- FILTERS -->
        <section class="filters-section" aria-label="Filtres d'historique">
          <div class="filters-grid">
            <!-- Recherche -->
            <div class="search-wrapper">
              <div class="search-field">
                <div class="search-icon-box">
                  <span class="material-symbols-outlined">search</span>
                </div>
                <input
                  type="text"
                  class="search-input"
                  placeholder="Rechercher par immatriculation ou transporteur..."
                  [(ngModel)]="searchTerm"
                  (ngModelChange)="applyFilters()"
                />
              </div>
            </div>
            <!-- Filtres sous forme de "chips" -->
            <div class="filter-chips-row">
              <!-- Filtre Entrepôt -->
              <div class="filter-chip">
                <span>Entrepôt</span>
                <select
                  class="filter-select"
                  [(ngModel)]="selectedWarehouseId"
                  (change)="applyFilters()"
                >
                  <option [ngValue]="'all'">Tous</option>
                  <option *ngFor="let w of warehousesOptions" [ngValue]="w.id">
                    {{ w.name }}
                  </option>
                </select>
                <span class="material-symbols-outlined">arrow_drop_down</span>
              </div>

              <!-- Filtre Période -->
              <div class="filter-chip">
                <span>Période</span>
                <select
                  class="filter-select"
                  [(ngModel)]="selectedPeriod"
                  (change)="applyFilters()"
                >
                  <option value="all">Toutes les périodes</option>
                  <option value="today">Aujourd'hui</option>
                  <option value="7days">7 derniers jours</option>
                  <option value="30days">30 derniers jours</option>
                </select>
                <span class="material-symbols-outlined">arrow_drop_down</span>
              </div>

              <!-- Filtre Statut -->
              <div class="filter-chip">
                <span>Statut</span>
                <select
                  class="filter-select"
                  [(ngModel)]="selectedStatus"
                  (change)="applyFilters()"
                >
                  <option [ngValue]="'all'">Tous</option>
                  <option value="En attente">En attente</option>
                  <option value="En cours de déchargement">En cours de déchargement</option>
                  <option value="Déchargé">Déchargé</option>
                  <option value="Annulé">Annulé</option>
                </select>
                <span class="material-symbols-outlined">arrow_drop_down</span>
              </div>
            </div>
          </div>
        </section>

        <!-- TABLE -->
        <section class="table-card" aria-label="Tableau des passages">
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Entrepôt</th>
                  <th>Immatriculation</th>
                  <th>Transporteur</th>
                  <th>Date Arrivée Camion</th>
                  <th>Heure d'enrégistrement</th>
                  <th>Statut</th>
                  <th class="action-cell">Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- Si aucune ligne -->
                <tr *ngIf="filteredRows.length === 0">
                  <td colspan="9" class="cell-muted">
                    Aucun passage ne correspond à vos filtres pour le moment.
                  </td>
                </tr>

                <!-- Lignes d'historique -->
                <ng-container *ngIf="filteredRows.length > 0">
                  <tr *ngFor="let row of filteredRows">
                    <td class="cell-muted">{{ row.entrepotName }}</td>
                    <td class="cell-main">{{ row.immatriculation }}</td>
                    <td class="cell-muted">{{ row.transporteur }}</td>
                    <td class="cell-muted">
                      {{ row.createdAt | date : 'dd/MM/yyyy' }}
                    </td>
                    <!-- Heure d'enregistrement (USER) -->
                    <td class="cell-muted">
                      {{ formatHeure(row.createdAt) }}
                    </td>

                    <td>
                      <span [ngClass]="getStatusCssClass(row.statut)">
                        <span class="material-symbols-outlined status-icon">{{
                          getStatusIcon(row.statut)
                        }}</span>
                        {{ row.statut }}
                      </span>
                    </td>
                    <td class="action-cell">
                      <button
                        type="button"
                        class="icon-ghost-button"
                        title="Voir le détail du passage"
                        (click)="openDetailsModal(row)"
                      >
                        <span class="material-symbols-outlined">visibility</span>
                      </button>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
        </section>

        <!-- HISTORIQUE MODAL (comme dans Entrepôt) -->
        <div class="modal" *ngIf="showDetailsModal">
          <div class="modal__backdrop" (click)="closeDetailsModal()"></div>
          <div class="modal__panel">
            <div class="truck-modal">
              <div class="truck-modal-header">
                <h2 class="truck-modal-title">Historique du camion</h2>
                <button class="truck-modal-close" (click)="closeDetailsModal()" aria-label="Fermer">
                  <span class="material-symbols-outlined">close</span>
                </button>
              </div>

              <div class="truck-modal-body" *ngIf="selectedRow">
                <!-- Snapshot summary: conserve les infos principales du camion -->
                <div class="truck-summary">
                  <div class="truck-summary-row">
                    <div class="summary-key">Immatriculation</div>
                    <div class="summary-value">{{ selectedRow.immatriculation }}</div>
                  </div>
                  <div class="truck-summary-row">
                    <div class="summary-key">Transporteur</div>
                    <div class="summary-value">{{ selectedRow.transporteur || '—' }}</div>
                  </div>
                  <div class="truck-summary-row">
                    <div class="summary-key">Entrepôt</div>
                    <div class="summary-value">{{ selectedRow.entrepotName }}</div>
                  </div>
                  <div class="truck-summary-row">
                    <div class="summary-key">Date arrivée</div>
                    <div class="summary-value">
                      {{ selectedRow.createdAt | date : 'dd/MM/yyyy' }} •
                      {{ formatHeure(selectedRow.createdAt) }}
                    </div>
                  </div>
                  <div class="truck-summary-row">
                    <div class="summary-key">KOR</div>
                    <div class="summary-value">{{ selectedRow.kor || '—' }}</div>
                  </div>
                  <div class="truck-summary-row">
                    <div class="summary-key">TH</div>
                    <div class="summary-value">{{ selectedRow.th || '—' }}</div>
                  </div>
                  <div class="truck-summary-row">
                    <div class="summary-key">Statut</div>
                    <div class="summary-value">
                      <span [ngClass]="getStatusCssClass(selectedRow.statut)">
                        <span class="material-symbols-outlined status-icon">{{
                          getStatusIcon(selectedRow.statut)
                        }}</span>
                        {{ selectedRow.statut }}
                      </span>
                    </div>
                  </div>
                </div>

                <div class="history-section">
                  <div
                    *ngIf="!selectedRow.history || selectedRow.history.length === 0"
                    class="notif-empty"
                  >
                    Aucun historique disponible.
                  </div>

                  <div *ngFor="let h of selectedRow.history" class="history-item">
                    <div class="history-dot" aria-hidden></div>
                    <div class="history-content">
                      <div class="history-event">{{ h.event }}</div>
                      <div class="history-meta">
                        <strong>{{ h.by || '—' }}</strong> •
                        {{ h.date | date : 'dd/MM/yyyy HH:mm' }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="truck-modal-footer">
                <button class="truck-submit" (click)="closeDetailsModal()">Fermer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</body>
